<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Customer Search Error Fix Test</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: #f9f9f9; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
        }
        button:hover { 
            background: #0056b3; 
        }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        input[type="email"] { 
            padding: 8px 12px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 3px; 
            width: 300px; 
        }
        .form-group { 
            margin: 15px 0; 
        }
        label { 
            display: inline-block; 
            width: 120px; 
            font-weight: bold; 
        }
        .result-display { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 10px 0; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Quick Customer Search Error Fix Test</h1>
        <div class="warning">
            <strong>üö® Important:</strong> Make sure the server is running on port 3004 before testing!
        </div>

        <!-- Server Status Check -->
        <div class="test-section">
            <h2>üåê Server Status</h2>
            <button onclick="checkServerStatus()">Check Server Status</button>
            <div id="serverStatus"></div>
        </div>

        <!-- Quick Test with Common Scenarios -->
        <div class="test-section">
            <h2>‚ö° Quick Tests</h2>
            <p>Test common scenarios that cause the customer search error:</p>
            
            <button class="btn-warning" onclick="testWithServiceProvider()">Test Service Provider Email</button>
            <button class="btn-info" onclick="testWithNonExistentUser()">Test Non-Existent User</button>
            <button class="btn-success" onclick="createAndTestCustomer()">Create & Test Customer</button>
            
            <div id="quickTestResults"></div>
        </div>

        <!-- Manual Test -->
        <div class="test-section">
            <h2>‚úèÔ∏è Manual Test</h2>
            <div class="form-group">
                <label for="testEmail">Test Email:</label>
                <input type="email" id="testEmail" placeholder="Enter email to test" value="test@customer.com">
                <button onclick="testCustomerSearch()">Test Customer Search</button>
                <button class="btn-warning" onclick="fixAndTest()">Fix & Test</button>
            </div>
            <div id="manualTestResults"></div>
        </div>

        <!-- Fix Options -->
        <div class="test-section">
            <h2>üîß Fix Options</h2>
            <div class="form-group">
                <label for="fixEmail">Email to Fix:</label>
                <input type="email" id="fixEmail" placeholder="Enter email to fix">
            </div>
            <button class="btn-success" onclick="autoFixCustomer()">Auto-Fix Customer Issue</button>
            <button class="btn-warning" onclick="convertToCustomer()">Convert to Customer</button>
            <button class="btn-danger" onclick="createNewCustomer()">Create New Customer</button>
            <div id="fixResults"></div>
        </div>
    </div>

    <script>
        function displayResult(elementId, data, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML = `
                <div class="status ${type}">
                    <strong>[${timestamp}] Result:</strong>
                    <div class="result-display">${JSON.stringify(data, null, 2)}</div>
                </div>
            `;
        }

        function displayMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML = `<div class="status ${type}">[${timestamp}] ${message}</div>`;
        }

        async function checkServerStatus() {
            displayMessage('serverStatus', 'üîç Checking server status...', 'info');
            
            try {
                const response = await fetch('/health');
                const data = await response.json();
                displayResult('serverStatus', {
                    status: '‚úÖ Server is running!',
                    serverData: data,
                    testEndpoints: [
                        '/fetch-one',
                        '/debug-customer', 
                        '/quick-fix-customer',
                        '/fix-customer-profile-search.html'
                    ]
                }, 'success');
            } catch (error) {
                displayResult('serverStatus', {
                    status: '‚ùå Server is not running or not responding',
                    error: error.message,
                    solution: 'Please start the server with: node server.js'
                }, 'error');
            }
        }

        async function testWithServiceProvider() {
            displayMessage('quickTestResults', 'üß™ Testing with Service Provider email...', 'info');
            
            try {
                const response = await fetch('/fetch-one?kuchEmail=provider@example.com');
                const data = await response.json();
                
                if (response.status === 400 && data.userType) {
                    displayResult('quickTestResults', {
                        test: 'Service Provider Email Test',
                        result: '‚úÖ WORKING - Correctly identified as Service Provider',
                        response: data,
                        note: 'This is the expected behavior for non-customer users'
                    }, 'success');
                } else {
                    displayResult('quickTestResults', {
                        test: 'Service Provider Email Test',
                        result: '‚ùì Unexpected response',
                        response: data,
                        status: response.status
                    }, 'warning');
                }
            } catch (error) {
                displayResult('quickTestResults', {
                    test: 'Service Provider Email Test',
                    result: '‚ùå Error occurred',
                    error: error.message
                }, 'error');
            }
        }

        async function testWithNonExistentUser() {
            displayMessage('quickTestResults', 'üß™ Testing with non-existent user...', 'info');
            
            try {
                const response = await fetch('/fetch-one?kuchEmail=nonexistent@user.com');
                const data = await response.json();
                
                if (response.status === 404) {
                    displayResult('quickTestResults', {
                        test: 'Non-Existent User Test',
                        result: '‚úÖ WORKING - Correctly handled non-existent user',
                        response: data
                    }, 'success');
                } else {
                    displayResult('quickTestResults', {
                        test: 'Non-Existent User Test',
                        result: '‚ùì Unexpected response',
                        response: data,
                        status: response.status
                    }, 'warning');
                }
            } catch (error) {
                displayResult('quickTestResults', {
                    test: 'Non-Existent User Test',
                    result: '‚ùå Error occurred',
                    error: error.message
                }, 'error');
            }
        }

        async function createAndTestCustomer() {
            displayMessage('quickTestResults', 'üß™ Creating test customer and testing...', 'info');
            
            try {
                // First create a test customer
                const createResponse = await fetch('/create-test-customer');
                const createData = await createResponse.json();
                
                if (createData.success) {
                    // Now test the customer search
                    const testResponse = await fetch('/fetch-one?kuchEmail=testcustomer@example.com');
                    const testData = await testResponse.json();
                    
                    if (testResponse.ok) {
                        displayResult('quickTestResults', {
                            test: 'Create & Test Customer',
                            result: '‚úÖ PERFECT - Customer creation and search working!',
                            customerCreated: createData,
                            searchResult: testData
                        }, 'success');
                    } else {
                        displayResult('quickTestResults', {
                            test: 'Create & Test Customer', 
                            result: '‚ö†Ô∏è Customer created but search failed',
                            customerCreated: createData,
                            searchError: testData
                        }, 'warning');
                    }
                } else {
                    displayResult('quickTestResults', {
                        test: 'Create & Test Customer',
                        result: '‚ùå Failed to create test customer',
                        error: createData
                    }, 'error');
                }
            } catch (error) {
                displayResult('quickTestResults', {
                    test: 'Create & Test Customer',
                    result: '‚ùå Error occurred',
                    error: error.message
                }, 'error');
            }
        }

        async function testCustomerSearch() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                displayMessage('manualTestResults', '‚ùå Please enter an email to test', 'error');
                return;
            }

            displayMessage('manualTestResults', `üß™ Testing customer search for: ${email}`, 'info');
            
            try {
                const response = await fetch(`/fetch-one?kuchEmail=${encodeURIComponent(email)}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayResult('manualTestResults', {
                        test: `Customer Search Test for ${email}`,
                        result: '‚úÖ SUCCESS - Customer found!',
                        customerData: data
                    }, 'success');
                } else {
                    displayResult('manualTestResults', {
                        test: `Customer Search Test for ${email}`,
                        result: `‚ùå FAILED - ${data.error}`,
                        status: response.status,
                        errorData: data,
                        nextStep: 'Try the Fix & Test button or use the Fix Options below'
                    }, 'error');
                }
            } catch (error) {
                displayResult('manualTestResults', {
                    test: `Customer Search Test for ${email}`,
                    result: '‚ùå ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function fixAndTest() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                displayMessage('manualTestResults', '‚ùå Please enter an email to fix and test', 'error');
                return;
            }

            displayMessage('manualTestResults', `üîß Fixing and testing: ${email}`, 'info');
            
            try {
                // First try to fix the customer
                const fixResponse = await fetch(`/quick-fix-customer?email=${encodeURIComponent(email)}`);
                const fixData = await fixResponse.json();
                
                if (fixData.success) {
                    // Now test the search
                    const testResponse = await fetch(`/fetch-one?kuchEmail=${encodeURIComponent(email)}`);
                    const testData = await testResponse.json();
                    
                    displayResult('manualTestResults', {
                        fix: fixData,
                        test: testResponse.ok ? {
                            result: '‚úÖ Customer search now working!',
                            data: testData
                        } : {
                            result: '‚ùå Still not working',
                            error: testData
                        }
                    }, testResponse.ok ? 'success' : 'warning');
                } else {
                    displayResult('manualTestResults', {
                        result: '‚ùå Fix failed',
                        error: fixData
                    }, 'error');
                }
            } catch (error) {
                displayResult('manualTestResults', {
                    result: '‚ùå Error during fix and test',
                    error: error.message
                }, 'error');
            }
        }

        async function autoFixCustomer() {
            const email = document.getElementById('fixEmail').value;
            if (!email) {
                displayMessage('fixResults', '‚ùå Please enter an email to fix', 'error');
                return;
            }

            displayMessage('fixResults', `üîß Auto-fixing customer issue for: ${email}`, 'info');
            
            try {
                const response = await fetch(`/quick-fix-customer?email=${encodeURIComponent(email)}`);
                const data = await response.json();
                
                if (data.success) {
                    displayResult('fixResults', {
                        result: '‚úÖ Auto-fix completed successfully!',
                        action: data.action,
                        details: data
                    }, 'success');
                } else {
                    displayResult('fixResults', {
                        result: '‚ùå Auto-fix failed',
                        error: data
                    }, 'error');
                }
            } catch (error) {
                displayResult('fixResults', {
                    result: '‚ùå Error during auto-fix',
                    error: error.message
                }, 'error');
            }
        }

        async function convertToCustomer() {
            const email = document.getElementById('fixEmail').value;
            if (!email) {
                displayMessage('fixResults', '‚ùå Please enter an email to convert', 'error');
                return;
            }

            displayMessage('fixResults', `üîÑ Converting user to customer: ${email}`, 'info');
            
            try {
                const response = await fetch(`/fix-user-type?email=${encodeURIComponent(email)}&usertype=Customer`);
                const data = await response.json();
                
                if (data.success) {
                    displayResult('fixResults', {
                        result: '‚úÖ User converted to Customer successfully!',
                        details: data
                    }, 'success');
                } else {
                    displayResult('fixResults', {
                        result: '‚ùå Conversion failed',
                        error: data
                    }, 'error');
                }
            } catch (error) {
                displayResult('fixResults', {
                    result: '‚ùå Error during conversion',
                    error: error.message
                }, 'error');
            }
        }

        async function createNewCustomer() {
            const email = document.getElementById('fixEmail').value;
            if (!email) {
                displayMessage('fixResults', '‚ùå Please enter an email for new customer', 'error');
                return;
            }

            displayMessage('fixResults', `‚ûï Creating new customer account: ${email}`, 'info');
            
            try {
                const response = await fetch('/saveProfile?' + new URLSearchParams({
                    txtEmail: email,
                    txtPwd: 'temp123',
                    utype: 'Customer'
                }));
                
                const result = await response.text();
                
                if (result.includes('Successfully')) {
                    displayResult('fixResults', {
                        result: '‚úÖ New customer account created successfully!',
                        email: email,
                        tempPassword: 'temp123',
                        note: 'Account created with temporary password. User should update it.'
                    }, 'success');
                } else {
                    displayResult('fixResults', {
                        result: '‚ùå Failed to create customer account',
                        error: result
                    }, 'error');
                }
            } catch (error) {
                displayResult('fixResults', {
                    result: '‚ùå Error creating customer account',
                    error: error.message
                }, 'error');
            }
        }

        // Auto-check server status on page load
        window.onload = function() {
            console.log('Quick Customer Search Error Fix Test loaded');
            setTimeout(checkServerStatus, 500);
        };
    </script>
</body>
</html>
